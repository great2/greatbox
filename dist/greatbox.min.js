'use strict';

/*==================================================*\
        Greatbox
\*==================================================*/
;(function ($) {
  var announcement = false;

  // 一次性顯示/無綁定元素
  $.greatbox = function (userOpts, callback) {
    userOpts.announcement = true;
    $.fn.greatbox(userOpts, callback);
  };

  // 綁定事件 greatbox
  $.fn.greatbox = function () {
    var userOpts = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
    var callback = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : function () {};

    /* 預設樣板 */
    var boxTemp = '\n      <div class="greatbox">\n        <div class="gb-container">\n          <div class="gb-content"></div>\n        </div>\n      </div>\n    ';
    var closeBtnTemp = '<div class="gb-close-btn"></div>';
    var loadingTemp = '\n      <div class="gb-loading">\n        <svg><path d="M43.935,25.145c0-10.318-8.364-18.683-18.683-18.683c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615c8.072,0,14.615,6.543,14.615,14.615H43.935z"><animateTransform attributeType="xml"attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"/></path></svg>\n      </div>\n    ';

    /* 預設選項 */
    var _defaultOpts = {
      path: {
        filesRoot: './includes/greatbox/',
        filesDefaultExtension: '.html'
      },
      announcement: false,
      fileName: [],
      contentType: 'file',
      bindEvt: 'click',
      closeBtn: true,
      bodyClickClose: true,
      showWhenLanding: false,
      duration: 200,
      boxTemp: boxTemp,
      closeBtnTemp: closeBtnTemp,
      loadingTemp: loadingTemp,
      callback: function callback() {}

      // Options Extend
    };var opts = $.extend(_defaultOpts, userOpts);
    // 如果不要關閉按鈕，則強制開啟 "點擊 body 可關閉 lightbox" 功能
    !opts.closeBtn && (opts.bodyClickClose = true);

    var init = function init(idx, el) {
      var $el = $(el);
      $el.click(function (evt) {
        evt.stopPropagation();
      });
      opts.fileName.push($el.data('gb'));
      opts.announcement ? buildTemp(idx) : $el.on(opts.bindEvt, function () {
        if (!!$('.greatbox').length) throw new Error('已有 Greatbox 存在');
        buildTemp(idx);
      });
    };

    /*==================== Methods ====================*/
    // 建立模組
    var buildTemp = function buildTemp(idx) {
      $('body').append(opts.boxTemp);
      $('.greatbox').append(opts.loadingTemp).addClass(opts.fileName[idx]);
      opts.closeBtn && $('.gb-container').append(opts.closeBtnTemp);

      tempEvtBing();
      loadFile(idx, loadFileCallback);
    };

    /* Content Show/Hide */
    var loadFileCallback = function loadFileCallback() {
      $('.gb-container img').on('load', function () {
        $('.gb-container').stop().animate({
          opacity: 1
        }, opts.duration);
        $('.gb-loading').stop().animate({
          opacity: 0
        }, opts.duration);
      });
    };

    /* Template Events Bingind */
    var tempEvtBing = function tempEvtBing() {
      // Container Stop Propagation
      $('.gb-container').click(function (evt) {
        evt.stopPropagation();
      });

      opts.closeBtn && $('.gb-close-btn').click(closeGB);
      opts.bodyClickClose && $('body').click(closeGB);

      $('.greatbox').fadeIn(opts.duration);
    };

    /* 取得完整路徑 */
    var getFullPath = function getFullPath(idx) {
      var _opts$path = opts.path,
          root = _opts$path.filesRoot,
          ext = _opts$path.filesDefaultExtension;


      return '' + root + opts.fileName[idx] + ext;
    };

    /* Download File */
    var loadFile = function loadFile(idx, callback) {
      $('.gb-content').load(getFullPath(idx), callback);
    };

    /* Close Greatbox */
    var closeGB = function closeGB() {
      var $gb = $('.greatbox');
      if (!$gb.length) return false;
      // 需調整: 開放使用者自定義
      $gb.fadeOut(opts.duration, function () {
        $gb.remove();
      });
    };

    /*==================== Entrance ====================*/
    $.each([].slice.call(this), init);
    return this;
  };
})(jQuery);